<div class="learning-root">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ONBOARDING GATE â€” shown on first visit
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <app-onboarding *ngIf="!onboarding.isOnboardingComplete()"></app-onboarding>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INFO POPOVER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="popover-backdrop" *ngIf="showInfoPopover()" (click)="closeInfoPopover()">
    <div class="popover-card" (click)="$event.stopPropagation()" *ngIf="stageGuide() as guide">
      <button class="popover-close" (click)="closeInfoPopover()" aria-label="Close">âœ•</button>

      <div class="popover-header">
        <span class="popover-stage-label">Stage {{ guide.stage }}</span>
        <h2>{{ guide.technique }}</h2>
      </div>

      <div class="popover-items">
        <div class="popover-item" *ngFor="let item of guide.guideItems">
          <span class="item-icon">{{ item.icon }}</span>
          <div>
            <strong>{{ item.title }}</strong>
            <p>{{ item.description }}</p>
          </div>
        </div>
      </div>

      <div class="popover-citation">
        <span class="citation-icon">ğŸ“š</span>
        <div>
          <strong>{{ guide.culturalContext.tradition }}</strong>
          <p>{{ guide.culturalContext.citation }}</p>
        </div>
      </div>

      <div class="popover-pass">
        <span>ğŸ¯ Pass condition:</span> {{ guide.passThreshold }}
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GALLERY STATE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="gallery-view" *ngIf="gameState === 'GALLERY'">

    <!-- Top bar -->
    <header class="gallery-header">
      <a class="back-btn" routerLink="/game-mode">â† Modes</a>
      <h1>Guru Protocol</h1>
      <div class="guru-badge" [style.color]="guruScoreColor()">
        <span class="guru-score">{{ guruScore() }}</span>
        <span class="guru-label">Guru Score</span>
      </div>
    </header>

    <!-- Stage progress stepper -->
    <div class="stage-stepper">
      <div *ngFor="let s of [1,2,3,4,5]"
           class="stage-node"
           [class.unlocked]="stageIsUnlocked(s)"
           [class.active]="currentStage() === s">
        <div class="node-circle">
          <span *ngIf="stageIsUnlocked(s)">{{ s }}</span>
          <span *ngIf="!stageIsUnlocked(s)">ğŸ”’</span>
        </div>
        <span class="node-label">{{ stageGuides[s-1].stageName }}</span>
      </div>
    </div>

    <!-- Tier selector -->
    <div class="tier-selector">
      <button (click)="galleryTier = 'Beginner'"     [class.active]="galleryTier === 'Beginner'"    >Beginner</button>
      <button (click)="galleryTier = 'Intermediate'" [class.active]="galleryTier === 'Intermediate'" >Intermediate</button>
      <button (click)="galleryTier = 'Advanced'"     [class.active]="galleryTier === 'Advanced'"    >Advanced</button>
    </div>

    <!-- Pattern grid -->
    <div class="pattern-grid">
      <div *ngFor="let p of filteredPatterns"
           class="pattern-card"
           [class.locked]="!isUnlocked(p.id)"
           (click)="selectPattern(p)">
        <div class="pattern-thumb">
          <div class="placeholder-art" [style.background]="'hsl(' + (p.id*20) + ', 55%, 25%)'"></div>
          <div class="pattern-shine"></div>
          <span class="lock-icon" *ngIf="!isUnlocked(p.id)">ğŸ”’</span>
        </div>
        <div class="pattern-info">
          <h3>{{ p.name }}</h3>
          <div class="stars">
            <span *ngFor="let s of [1,2,3,4,5]" [class.filled]="s <= p.difficulty">â˜…</span>
          </div>
          <span class="symmetry-tag">{{ p.symmetryAxes }}-fold</span>
        </div>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PREVIEW MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-backdrop" *ngIf="gameState === 'PREVIEW' && currentPattern">
    <div class="modal-card">
      <h2>{{ currentPattern.name }}</h2>
      <p class="cultural-note">{{ currentPattern.culturalNote }}</p>

      <div class="preview-stats">
        <div class="stat"><span class="stat-val">{{ currentPattern.symmetryAxes }}</span><span class="stat-key">-fold symmetry</span></div>
        <div class="stat"><span class="stat-val">{{ currentPattern.difficulty }}</span><span class="stat-key">/5 difficulty</span></div>
        <div class="stat"><span class="stat-val">{{ stageLabel() }}</span><span class="stat-key">stage</span></div>
      </div>

      <div class="modal-actions">
        <button class="btn-primary" (click)="startLevel()">Begin Drawing</button>
        <button class="btn-ghost"   (click)="gameState = 'GALLERY'">Back</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PLAYING STATE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="playing-view" *ngIf="gameState === 'PLAYING'">

    <!-- Top HUD -->
    <div class="hud">
      <button class="hud-quit"    (click)="backToGallery()">âœ• Quit</button>

      <div class="hud-stage">
        <span class="stage-pill">Stage {{ currentStage() }} Â· {{ stageLabel() }}</span>
        <button class="info-btn" (click)="openInfoPopover()" title="Stage guide">â„¹</button>
      </div>

      <div class="hud-metrics">
        <div class="mini-metric">
          <span class="mm-label">Grip</span>
          <div class="mm-bar"><div class="mm-fill grip" [style.width.%]="metricPct(liveMetrics().pressureConsistency)"></div></div>
        </div>
        <div class="mini-metric">
          <span class="mm-label">Flow</span>
          <div class="mm-bar"><div class="mm-fill flow" [style.width.%]="metricPct(liveMetrics().velocityConsistency)"></div></div>
        </div>
        <div class="mini-metric">
          <span class="mm-label">Angle</span>
          <div class="mm-bar"><div class="mm-fill angle" [style.width.%]="metricPct(liveMetrics().angularPrecision)"></div></div>
        </div>
      </div>

      <div class="accuracy-chip">
        <span>{{ accuracy }}%</span>
        <div class="acc-bar"><div class="acc-fill" [style.width.%]="accuracy"></div></div>
      </div>

      <div class="hud-tools">
        <label class="toggle-pill">
          <input type="checkbox" [(ngModel)]="showGhostOverlay">
          <span>ğŸ‘»</span>
        </label>
        <label class="toggle-pill">
          <input type="checkbox" [(ngModel)]="showGuides">
          <span>ğŸ“</span>
        </label>
      </div>

      <button class="btn-finish" (click)="finishLevel()">Finish âœ“</button>
    </div>

    <!-- Dual canvas split -->
    <div class="canvas-split">
      <div class="canvas-panel target-panel">
        <div class="panel-label">Target</div>
        <div class="canvas-host" #targetCanvas></div>
      </div>
      <div class="canvas-panel player-panel">
        <div class="panel-label">Your Drawing</div>
        <div class="canvas-host" #playerCanvas></div>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESULTS STATE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-backdrop results-backdrop" *ngIf="gameState === 'RESULTS'">
    <div class="modal-card results-card" [class.passed]="sessionPassed">

      <div class="results-header">
        <span class="result-emoji">{{ sessionPassed ? 'ğŸ‰' : 'ğŸ’ª' }}</span>
        <h1>{{ sessionPassed ? 'Level Mastered!' : 'Keep Practicing' }}</h1>
        <div class="visual-score">{{ accuracy }}<sup>%</sup></div>
      </div>

      <!-- Skill breakdown -->
      <div class="skill-breakdown">
        <h3>Skill Metrics</h3>
        <div class="skill-row">
          <span>Grip Steady</span>
          <div class="sk-bar"><div class="sk-fill" [style.width.%]="metricPct(liveMetrics().pressureConsistency)"></div></div>
          <span class="sk-val">{{ metricPct(liveMetrics().pressureConsistency) }}%</span>
        </div>
        <div class="skill-row">
          <span>Flow</span>
          <div class="sk-bar"><div class="sk-fill" [style.width.%]="metricPct(liveMetrics().velocityConsistency)"></div></div>
          <span class="sk-val">{{ metricPct(liveMetrics().velocityConsistency) }}%</span>
        </div>
        <div class="skill-row">
          <span>Angle</span>
          <div class="sk-bar"><div class="sk-fill" [style.width.%]="metricPct(liveMetrics().angularPrecision)"></div></div>
          <span class="sk-val">{{ metricPct(liveMetrics().angularPrecision) }}%</span>
        </div>
        <div class="skill-row">
          <span>Flow State</span>
          <div class="sk-bar"><div class="sk-fill flow" [style.width.%]="metricPct(liveMetrics().flowStateIndex)"></div></div>
          <span class="sk-val">{{ metricPct(liveMetrics().flowStateIndex) }}%</span>
        </div>
      </div>

      <!-- Feedback -->
      <div class="feedback-list">
        <p *ngFor="let f of sessionFeedback" class="feedback-msg">{{ f }}</p>
      </div>

      <!-- New Achievements -->
      <div class="achievements" *ngIf="newAchievements.length > 0">
        <div class="ach-item" *ngFor="let a of newAchievements">
          <span class="ach-icon">{{ a.icon }}</span>
          <div>
            <strong>{{ a.name }}</strong>
            <p>{{ a.description }}</p>
          </div>
        </div>
      </div>

      <!-- Guru Score delta -->
      <div class="guru-score-display">
        <span class="gsd-label">Guru Score</span>
        <span class="gsd-val" [style.color]="guruScoreColor()">{{ finalGuruScore }}</span>
      </div>

      <div class="modal-actions">
        <button class="btn-primary" (click)="startLevel()" *ngIf="!sessionPassed">Try Again</button>
        <button class="btn-ghost"   (click)="backToGallery()">Back to Gallery</button>
      </div>

    </div>
  </div>

</div>
